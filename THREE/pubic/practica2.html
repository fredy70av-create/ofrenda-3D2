<<!DOCTYPE html>
<html lang="es">
<head>
  <title>Ofrenda de Día de Muertos 3D</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
<canvas id="canvasPrincipal"></canvas>

<script type="importmap">
{
  "imports": {
    "three": "./js/three.module.js",
    "three/OrbitControls": "./js/OrbitControls.js"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/OrbitControls';

// ---------- RENDER ----------
const renderizador = new THREE.WebGLRenderer({
  canvas: document.getElementById('canvasPrincipal'),
  antialias: true
});
renderizador.setPixelRatio(window.devicePixelRatio);
renderizador.setSize(window.innerWidth, window.innerHeight);
renderizador.setClearColor(0x000000);
renderizador.shadowMap.enabled = true;

// ---------- ESCENA Y CÁMARA ----------
const escena = new THREE.Scene();
const camara = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
camara.position.set(0, 10, 30);
camara.lookAt(0, 2, 0);
escena.add(camara);

// ---------- FONDO DE IMAGEN ----------
const geometryImg = new THREE.PlaneGeometry(300, 300);
const loader = new THREE.TextureLoader();
const bgTexture = loader.load('./assets/fondo.jpg');
escena.background = bgTexture;

// ---------- PLANO CON IMAGEN ----------

const texturapapel = loader.load("./assets/fondo.jpg");
texturapapel.wrapS = THREE.RepeatWrapping;
texturapapel.wrapT = THREE.RepeatWrapping;
texturapapel.repeat.set(1, 1);
const materialImg = new THREE.MeshLambertMaterial({
  map: texturapapel,
  transparent: true,
  side: THREE.DoubleSide
});
const planoImagen = new THREE.Mesh(geometryImg, materialImg);
planoImagen.position.set(0, 150, -150); 
escena.add(planoImagen);

// ---------- CONTROLES ----------
const controles = new OrbitControls(camara, renderizador.domElement);
controles.enableDamping = true;
controles.dampingFactor = 0.05;
controles.minDistance = 10;
controles.maxDistance = 50;
controles.maxPolarAngle = Math.PI / 2.2;

// ---------- LUCES ----------
escena.add(new THREE.AmbientLight(0xffffff, 0.4));
const luzPrincipal = new THREE.PointLight(0xffa95c, 2, 150);
luzPrincipal.position.set(5, 12, 10);
luzPrincipal.castShadow = true;
escena.add(luzPrincipal);

// ---------- SUELO ----------
const suelo = new THREE.Mesh(
  new THREE.PlaneGeometry(120, 120),
  new THREE.MeshStandardMaterial({ color: 0x2e2e2e })
);
suelo.rotation.x = -Math.PI / 2;
suelo.receiveShadow = true;
escena.add(suelo);

// ---------- ALTAR ----------
const materialAltar = new THREE.MeshStandardMaterial({ color: 0x8b4513 });
const crearNivel = (ancho, alto, fondo, y) => {
  const nivel = new THREE.Mesh(new THREE.BoxGeometry(ancho, alto, fondo), materialAltar);
  nivel.position.set(0, y, 0);
  nivel.castShadow = true;
  nivel.receiveShadow = true;
  escena.add(nivel);
};
crearNivel(14, 1, 5, 0.5);
crearNivel(10, 1, 4, 1.2);
crearNivel(6, 1, 3, 2);

// ---------- FLORES ----------
const crearFlor = (x, y, z) => {
  const petaloMat = new THREE.MeshStandardMaterial({ color: 0xffa500, emissive: 0x331000 });
  const centroMat = new THREE.MeshStandardMaterial({ color: 0xff6600 });
  const centro = new THREE.Mesh(new THREE.SphereGeometry(0.35, 16, 16), centroMat);
  centro.position.set(x, y, z);
  escena.add(centro);
  for (let i = 0; i < 6; i++) {
    const petalo = new THREE.Mesh(new THREE.SphereGeometry(0.35, 16, 16), petaloMat);
    const ang = (i / 6) * Math.PI * 2;
    petalo.position.set(x + Math.cos(ang) * 0.55, y, z + Math.sin(ang) * 0.55);
    escena.add(petalo);
  }
};
for (let i = -6; i <= 6; i += 3) crearFlor(i, 1.2, 2.2);

// ---------- VELAS CON FLAMA ----------
const crearVela = (x, y, z) => {
  const cuerpo = new THREE.Mesh(
    new THREE.CylinderGeometry(0.3, 0.3, 1.6, 16),
    new THREE.MeshStandardMaterial({ color: 0xffffcc })
  );
  cuerpo.position.set(x, y + 0.8, z);
  escena.add(cuerpo);

  const luz = new THREE.PointLight(0xffaa33, 2, 6);
  luz.position.set(x, y + 1.6, z);
  escena.add(luz);

  const flamaMat = new THREE.MeshStandardMaterial({ color: 0xffcc33, emissive: 0xffaa00 });
  const flama = new THREE.Mesh(new THREE.ConeGeometry(0.15, 0.4, 16), flamaMat);
  flama.position.set(x, y + 1.6, z);
  escena.add(flama);
};

crearVela(-4, 1, 1.5);
crearVela(0, 1, 1.5);
crearVela(4, 1, 1.5);
crearVela(-3, 1.3, 1.5);
crearVela(3, 1.3, 1.5);

// ---------- MARCOS DE FOTOS ----------
const crearFoto = (x, y, z, color) => {
  const marco = new THREE.Mesh(
    new THREE.BoxGeometry(1.8, 2.2, 0.15),
    new THREE.MeshStandardMaterial({ color: 0x663300 })
  );
  marco.position.set(x, y, z);
  escena.add(marco);
  const retrato = new THREE.Mesh(
    new THREE.PlaneGeometry(1.4, 1.8),
    new THREE.MeshStandardMaterial({ color, emissive: color })
  );
  retrato.position.set(x, y, z + 0.08);
  escena.add(retrato);
};

// Portarretratos laterales
crearFoto(-2, 2.2, -7.8, 0xff9999);
crearFoto(2, 2.2, -7.8, 0xffff99);

// Portarretrato central
crearFoto(0, 3.5, -1, 0x99ccff);

// ---------- PAN DE MUERTO ----------
const crearPan = (x, y, z) => {
  const panMat = new THREE.MeshStandardMaterial({ color: 0xd2b48c });
  const pan = new THREE.Mesh(
    new THREE.SphereGeometry(0.9, 32, 32, 0, Math.PI * 2, 0, Math.PI / 2),
    panMat
  );
  pan.position.set(x, y, z);
  escena.add(pan);

  const huesitoMat = new THREE.MeshStandardMaterial({ color: 0xd2b48c });
  const posicionesHuesitos = [
    { x: 0, z: 0 }, { x: 0.3, z: 0 }, { x: -0.3, z: 0 },
    { x: 0, z: 0.3 }, { x: 0, z: -0.3 }
  ];
  posicionesHuesitos.forEach(pos => {
    const huesito = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.4), huesitoMat);
    huesito.position.set(x + pos.x, y + 0.2, z + pos.z);
    huesito.rotation.x = Math.PI / 2;
    escena.add(huesito);
  });
};

crearPan(-1.5, 1.8, 1.5);
crearPan(0, 1.8, 1.5);
crearPan(1.5, 1.8, 1.5);

// ---------- CALAVERAS ----------
const crearCalaveritaRealista = (x, y, z) => {
  const cabezaMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
  const cabeza = new THREE.Mesh(new THREE.SphereGeometry(0.55, 32, 32), cabezaMat);
  cabeza.position.set(x, y, z);
  escena.add(cabeza);

  const mandMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
  const mandibula = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.2, 0.3), mandMat);
  mandibula.position.set(x, y - 0.45, z + 0.05);
  escena.add(mandibula);

  const ojoMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
  const ojo1 = new THREE.Mesh(new THREE.SphereGeometry(0.1, 8, 8), ojoMat);
  const ojo2 = ojo1.clone();
  ojo1.position.set(x - 0.18, y + 0.1, z + 0.45);
  ojo2.position.set(x + 0.18, y + 0.1, z + 0.45);
  escena.add(ojo1, ojo2);

  const narizGeo = new THREE.ConeGeometry(.09, 1.1, 5);
  const nariz = new THREE.Mesh(narizGeo, ojoMat);
  nariz.position.set(x, y - 0.05, z + 0.25);
  nariz.rotation.x = Math.PI;
  escena.add(nariz);

  const pomuloMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
  const pomulo1 = new THREE.Mesh(new THREE.SphereGeometry(0.07, 16, 16), pomuloMat);
  const pomulo2 = pomulo1.clone();
  pomulo1.position.set(x - 0.22, y, z + 0.15);
  pomulo2.position.set(x + 0.22, y, z + 0.15);
  escena.add(pomulo1, pomulo2);
};

crearCalaveritaRealista(-2, 2.9, 0.8);
crearCalaveritaRealista(2, 2.9, 0.8);

// ---------- JARRA DE AGUA ----------
const jarraMat = new THREE.MeshStandardMaterial({ color: 0x3366cc });
const jarraCuerpo = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.9, 1.5, 32), jarraMat);
jarraCuerpo.position.set(6, 1.5, -0.5);
escena.add(jarraCuerpo);
const asaGeo = new THREE.TorusGeometry(0.5, 0.1, 16, 90, Math.PI);
const asa = new THREE.Mesh(asaGeo, jarraMat);
asa.position.set(6.9, 1.5, -0.5);
asa.rotation.z = Math.PI / 2;
escena.add(asa);

// ---------- VASOS DE AGUA AZULES ----------
const crearVasoAgua = (x, y, z) => {
  const vasoMat = new THREE.MeshStandardMaterial({ color: 0x0000ff });
  const vaso = new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.25, 0.7, 16), vasoMat);
  vaso.position.set(x, y, z);
  escena.add(vaso);
};
crearVasoAgua(-1.5, 2.85, -0.8);
crearVasoAgua(1.5, 2.85, -0.8);

// ---------- ANIMACIÓN ----------
const animate = () => {
  requestAnimationFrame(animate);
  controles.update();
  renderizador.render(escena, camara);
};
animate();

// ---------- AJUSTE DE PANTALLA ----------
window.addEventListener('resize', () => {
  camara.aspect = window.innerWidth / window.innerHeight;
  camara.updateProjectionMatrix();
  renderizador.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
